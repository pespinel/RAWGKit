name: Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build documentation
        run: |
          xcodebuild docbuild \
            -scheme RAWGKit \
            -derivedDataPath /tmp/docbuild \
            -destination 'generic/platform=iOS'

      - name: Process DocC Archive
        run: |
          # Find the .doccarchive
          DOCC_ARCHIVE=$(find /tmp/docbuild -name "*.doccarchive" | head -1)

          echo "Found archive: $DOCC_ARCHIVE"

          # Convert to static site
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --output-path ./docs

          # Fix paths for GitHub Pages subdirectory hosting
          # Convert absolute paths in HTML files
          find ./docs -name "*.html" -type f -exec sed -i '' \
            -e 's|href="/|href="/RAWGKit/|g' \
            -e 's|src="/|src="/RAWGKit/|g' \
            -e 's|var baseUrl = "/"|var baseUrl = "/RAWGKit/"|g' \
            {} +

          # Fix paths in JSON data files
          find ./docs -name "*.json" -type f | while read -r file; do
            sed -i '' \
              -e 's|"\\/documentation\\/|"\\/RAWGKit\\/documentation\\/|g' \
              -e 's|"\\/tutorials\\/|"\\/RAWGKit\\/tutorials\\/|g' \
              "$file"
          done

          echo "Documentation generated for GitHub Pages at /RAWGKit/"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          force_orphan: true
